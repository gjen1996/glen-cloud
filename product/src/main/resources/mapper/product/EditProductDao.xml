<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.glen.product.dao.EditProductDao">

   <select id="getAllProduct"  resultType="java.util.HashMap">
    	SELECT DISTINCT b.product_id,product_name
        from product a,product_edit_record b
        where a.product_id = b.product_id
        and user_name = #{userName}
	</select>
	
	<select id="getAllIccid"  resultType="java.util.HashMap">
    	SELECT 
    	       a.iccid,
    	       a.product_id,
    	       a.user_id,
    	       a.user_name,
    	       next_product_id,
    	       effective_date,
    	       cycle_begin,
    	       transfer_date,
    	       c.communication_plan
        from   store_terminnal_detail a
        LEFT JOIN 
               product_edit_record b
        on     a.iccid = b.iccid
        LEFT JOIN 
               product c
        on     a.product_id = c.product_id
        where  is_transfer = "1"
	</select>
	
		<select id="getIccid"  resultType="java.util.HashMap">
    	SELECT   a.iccid,
    	         a.user_id,
    	         a.user_name,
    	         cycle_begin,
    	         a.product_id,
    	         a.transfer_date,
    	         next_product_id,
    	         effective_date
        FROM     
                 store_terminnal_detail a
        LEFT JOIN
                 product_edit_record c
        on       a.iccid = c.iccid
            and  a.product_id = c.product_id
        where    is_transfer = "1"
        and      cycle_begin = (SELECT max(cycle_begin) from product_edit_record where iccid = #{iccid})
        and      a.iccid = #{iccid}
	</select>
	
	
	     <insert id="insetOrUpdate" parameterType="java.util.List">
	       INSERT INTO product_edit_record
               (id,
                user_id,
                user_name,
                iccid,
                product_id,
                cycle_begin,
                next_product_id,
                effective_date)
           VALUES
		<foreach  collection="list" item="EditProductEntity" separator=",">  
		   (
			    null,
                #{EditProductEntity.userId}, 
                #{EditProductEntity.userName},
                #{EditProductEntity.iccid},
                #{EditProductEntity.productId},
                #{EditProductEntity.cycleBegin},
                #{EditProductEntity.nextProductId},
                #{EditProductEntity.effectiveDate}
		   )
		</foreach>
		   ON DUPLICATE KEY UPDATE 
			   cycle_begin = VALUES(cycle_begin),
			   next_product_id = VALUES(next_product_id),
			   effective_date = VALUES(effective_date)
	</insert>
	
</mapper>